# ANDROID_AGENT TODO LIST - Critical Issues & Improvements
# Generated: January 16, 2026

================================================================================
PHASE 1: CRITICAL FIXES (Nguy hi·ªÉm nh·∫•t - Fix ngay)
================================================================================

üî¥ ULTRA CRITICAL (Nguy hi·ªÉm h·ªá th·ªëng):
--------------------------------------------------------------------------------
1. Fix File Write Race Condition
   Status: COMPLETED
   Description: Th√™m UUID/thread ID v√†o t√™n file trong download_temp_file() ƒë·ªÉ tr√°nh conflict khi multiple threads download c√πng URL
   Files: android_agent/utils.py (download_temp_file function)
   Impact: Critical - File corruption, installation failures
   Priority: HIGH

2. Fix os.rename() Race Condition
   Status: COMPLETED
   Description: Th√™m lock ho·∫∑c atomic operations cho logic rename file trong net-install
   Files: android_agent/command_processor.py (net-install section)
   Impact: Critical - FileNotFoundError, crashes
   Priority: HIGH

3. Fix Head-of-Line Blocking
   Status: COMPLETED
   Description: Thay th·∫ø List commands b·∫±ng Queue ƒë·ªÉ cho ph√©p queue l·ªánh m·ªõi khi worker ƒëang x·ª≠ l√Ω batch c≈©
   Files: android_agent/main.py (commands handling logic)
   Impact: Critical - System throughput degradation
   Priority: HIGH

4. Add Thread.join() Timeout
   Status: COMPLETED
   Description: Th√™m timeout cho t·∫•t c·∫£ thread.join() trong main.py ƒë·ªÉ tr√°nh deadlock vƒ©nh vi·ªÖn
   Files: android_agent/main.py (regular_batch processing)
   Impact: Critical - System hangs indefinitely
   Priority: HIGH

üü° CRITICAL (Nguy hi·ªÉm ·ªïn ƒë·ªãnh h·ªá th·ªëng):
--------------------------------------------------------------------------------
5. Fix Process Leak in Session Manager
   Status: COMPLETED
   Description: Add timeout cho proc.communicate() trong session_manager loop()
   Files: android_agent/session_manager.py (handle_start_game loop)
   Impact: High - Resource leaks, hanging processes
   Priority: HIGH

6. Fix Memory Leak all_apk_files
   Status: COMPLETED
   Description: Th√™m threading.Lock ƒë·ªÉ b·∫£o v·ªá set all_apk_files trong multi-threading
   Files: android_agent/main.py (regular_batch worker_func)
   Impact: High - Memory leaks in long-running processes
   Priority: HIGH

7. Fix ADB Command Blocking & Server Overload
   Status: COMPLETED
   Description: ADB processes b·ªã treo d·∫´n ƒë·∫øn thread pool c·∫°n ki·ªát. ƒê√£ implement cross-platform force kill, ADB server restart v·ªõi thread synchronization, v√† health state machine
   Files: android_agent/adb_service.py, android_agent/log_manager.py
   Impact: Critical - System hangs when ADB server overloaded
   Priority: HIGH

8. Fix Resource Leaks on KeyboardInterrupt
   Status: COMPLETED
   Description: ƒê√£ implement cleanup_all_sessions() v√† force_stop_game_session() v·ªõi layered cleanup (signal‚Üíterminate‚ÜíADB force-stop). Th√™m timeout protection v√† comprehensive logging
   Files: android_agent/main.py, android_agent/session_manager.py
   Impact: Critical - Zombie processes after force shutdown
   Priority: HIGH

9. Fix Memory Accumulation in Commands Queue
   Status: COMPLETED
   Description: ƒê√£ implement maxlen=1000, batch locking optimization, overflow protection v·ªõi logging, v√† queue monitoring. NgƒÉn OOM crash v√† cung c·∫•p full observability
   Files: android_agent/main.py (commands deque + fetch logic), android_agent/config.py (queue config)
   Impact: High - OOM crash in long-running processes
   Priority: HIGH

10. Fix Log Collector Zombie Processes
    Status: COMPLETED
    Description: ƒê√£ implement Defense in Depth v·ªõi 4-level escalation (graceful‚Üígroup kill‚Üíforce kill‚ÜíOS kill). Cross-platform support, zombie detection, comprehensive logging
    Files: android_agent/log_manager.py (enhanced stop_collectors + force_kill functions)
    Impact: High - Resource leaks, ADB server starvation
    Priority: HIGH

================================================================================
PHASE 2: STABILITY IMPROVEMENTS (TƒÉng ƒë·ªô ·ªïn ƒë·ªãnh)
================================================================================

7. Add Game Process Heartbeat
   Status: COMPLETED
   Description: T·∫°o monitor thread ki·ªÉm tra PID game li√™n t·ª•c v√† auto-restart n·∫øu crash
   Files: android_agent/session_manager.py
   Impact: Medium - Undetected game crashes
   Priority: MEDIUM

8. Add API Retry Logic
   Status: COMPLETED
   Description: Implement exponential backoff v√† retry cho t·∫•t c·∫£ API calls trong api_client.py
   Files: android_agent/api_client.py
   Impact: High - Network failures cause data loss
   Priority: MEDIUM

9. Improve Resource Cleanup
   Status: COMPLETED
   Description: Th√™m try...finally blocks ƒë·ªÉ cleanup downloaded_files, processes, v√† file locks
   Files: android_agent/command_processor.py, android_agent/session_manager.py, android_agent/log_data.py
   Impact: Medium - Resource leaks, temp file accumulation
   Priority: MEDIUM

10. Fix File Handle Leaks with Context Managers
    Status: COMPLETED
    Description: ƒê√£ thay th·∫ø manual open/close b·∫±ng context manager v·ªõi append mode. Th√™m restart markers ƒë·ªÉ preserve crash logs. Lo·∫°i b·ªè manual cleanup code
    Files: android_agent/session_manager.py (enhanced loop with context manager)
    Impact: Medium - File descriptor leaks, "Too many open files" error
    Priority: MEDIUM

11. Add Network Resilience & Timeout Handling
    Status: COMPLETED
    Description: ƒê√£ implement production-grade resilience v·ªõi Circuit Breaker, jittered backoff, dynamic timeouts, smart error classification, v√† unified API client
    Files: android_agent/api_client.py (complete rewrite with resilience patterns)
    Impact: High - Command loss during network issues
    Priority: MEDIUM

12. Fix Process Group Management
    Status: COMPLETED
    Description: ƒê√£ implement kill_process_group_safe v·ªõi suicide prevention, process tree cleanup, cross-platform support, v√† zombie detection
    Files: android_agent/log_manager.py (enhanced process group management)
    Impact: Medium - Incomplete process cleanup
    Priority: MEDIUM

13. Add System Health Monitoring
    Status: COMPLETED
    Description: ƒê√£ implement comprehensive health monitoring v·ªõi psutil, state machine (HEALTHY‚ÜíWARNING‚ÜíCRITICAL‚ÜíEMERGENCY), configurable thresholds, metrics history, diagnostic reports, v√† alerting system
    Files: android_agent/health.py (new module), android_agent/config.py (thresholds), android_agent/main.py (integration + shutdown reports)
    Impact: Medium - Proactive detection of system degradation
    Priority: MEDIUM

================================================================================
PHASE 3: PERFORMANCE & MONITORING (T·ªëi ∆∞u hi·ªáu nƒÉng)
================================================================================

14. Add Process Health Monitoring
    Status: COMPLETED
    Description: Monitor ADB processes v√† log collectors, auto-restart n·∫øu die
    Files: android_agent/log_manager.py, android_agent/adb_service.py
    Impact: Low - Process failures not detected
    Priority: LOW

15. Add Connection Pooling
    Status: COMPLETED
    Description: Implement requests session reuse ƒë·ªÉ c·∫£i thi·ªán performance API calls
    Files: android_agent/api_client.py
    Impact: Low - Performance optimization
    Priority: LOW

16. Add Comprehensive Error Handling
    Status: PENDING
    Description: Th√™m proper logging v√† error recovery cho t·∫•t c·∫£ exception cases
    Files: All files - comprehensive error handling
    Impact: Medium - Better debugging and stability
    Priority: LOW

17. Fix Exception Object Memory Leaks
    Status: COMPLETED
    Description: ƒê√£ implement format_exception_safe(), safe_log_exception(), ExceptionSafeStorage class. Refactor exception handlers trong main.py v√† api_client.py ƒë·ªÉ tr√°nh memory leaks
    Files: android_agent/utils.py (new exception utilities), android_agent/main.py, android_agent/api_client.py
    Impact: Low - Memory leaks from exception accumulation
    Priority: LOW

18. Add Race Condition Protection for Log Data
    Status: COMPLETED
    Description: ƒê√£ implement local batching per process v·ªõi LogBatcher, RateLimiter, v√† background batch sender. NgƒÉn race conditions v√† API spam
    Files: android_agent/log_data.py (LogBatcher + RateLimiter classes, integrated batching)
    Impact: Low - Log data corruption in high concurrency
    Priority: LOW

================================================================================
COMPLETED ITEMS
================================================================================

- Fix ADB Timeout (adb_service.py) - COMPLETED
- Initial analysis and todo creation - COMPLETED
- Add Dynamic Timeout for ADB Operations - COMPLETED
- Fix File Write Race Condition (utils.py) - COMPLETED
- Fix os.rename() Race Condition (Prevention approach) - COMPLETED
- Fix Head-of-Line Blocking (collections.deque) - COMPLETED
- Add Thread.join() Timeout (Deadline Pattern) - COMPLETED
- Fix Process Leak in Session Manager (Polling Loop + Smart Circuit Breaker) - COMPLETED
- Fix Memory Leak all_apk_files (Data Embedding Approach) - COMPLETED
- Add Game Process Heartbeat (State Synchronization) - COMPLETED
- Add API Retry Logic (Exponential Backoff + Selective Retry) - COMPLETED
- Improve Resource Cleanup (Comprehensive Cleanup System) - COMPLETED
- Add Process Health Monitoring (Integrated Log Collector Monitoring) - COMPLETED
- Add Connection Pooling (Global Session v·ªõi HTTPAdapter) - COMPLETED
- Fix Process Leak in Session Manager (Polling Loop) - COMPLETED
- Comprehensive System Degradation Analysis - COMPLETED

================================================================================
NOTES
================================================================================

- Priority: HIGH = Fix immediately, MEDIUM = Fix soon, LOW = Nice to have
- Impact: Critical = System crash/hang, High = Major functionality, Medium = Minor issues, Low = Performance
- All fixes should include proper error handling and logging
- Test thoroughly with multiple devices after each fix
- Consider backward compatibility for all changes
- New critical issues added: ADB blocking, resource leaks, memory accumulation
- Focus on Phase 1 fixes first to prevent system degradation over time
